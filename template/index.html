<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civil 3D AI Assistant</title>

    <!-- Bootstrap 5.3.3 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google reCAPTCHA script -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <!-- DOMPurify for client-side sanitization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.7/purify.min.js"></script>

   <!-- Highlight.js Light Theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)">

    <!-- Highlight.js Dark Theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- Include Highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Include language support for VB.NET -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/vbnet.min.js"></script>

     <!-- Include Marked.js -->
     <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Initialize Highlight.js -->
    <script>
        hljs.highlightAll();
    </script>


    <!-- JavaScript Functions -->
    <script>
        // Show the container only after reCAPTCHA is solved
        function recaptchaCallback() {
            document.getElementById("main-container").style.display = "block";
            document.getElementById("recaptcha-message").style.display = "none";
        }
    
        // Fetch CSRF token from the form (assuming the CSRF token is added to the form as a hidden input)
        function getCSRFToken() {
            return document.querySelector('input[name="csrf_token"]').value;
        }
    
        // Show progress bar on form submit and update it
        function showProgress(event) {
            event.preventDefault(); // Prevent the form from submitting traditionally

            // Hide any previous error messages
            const warningElement = document.getElementById('warning-message');
            warningElement.style.display = "none";

            const submitButton = document.getElementById("submit-btn");
            submitButton.disabled = true; // Disable the button to prevent multiple submissions

            document.getElementById("progress-container").style.display = "block"; // Show the progress container
            var progressBar = document.getElementById("progress-bar");

            // Collect form data
            var formData = new FormData(event.target);

            // Reset progress bar
            progressBar.style.width = '0%';

            // Simulate progress bar moving with intervals
            var width = 0;
            var intervalTime = 100; // 100 ms interval
            var incrementFast = 80 / (45 * (1000 / intervalTime)); // Fast progress (first 80%)
            var incrementSlow = 20 / (45 * (1000 / intervalTime)); // Slow progress (last 20%)

            var progressInterval = setInterval(function() {
                if (width >= 100) {
                    clearInterval(progressInterval);
                } else if (width < 80) {
                    // Fast progress up to 80%
                    width += incrementFast;
                    if (width > 80) width = 80;
                } else {
                    // Slow progress for the remaining 20%
                    width += incrementSlow;
                    if (width > 100) width = 100;
                }
                progressBar.style.width = width + '%'; // Update the width of the progress bar
            }, intervalTime);

            // Submit the form to the /process route using POST
            fetch("/", {
                method: "POST",
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken(),  // Add the CSRF token to the headers
                    'X-Requested-With': 'XMLHttpRequest'  // Identify as AJAX request
                }
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                if (data.success) {
                    // After a short delay to allow the progress bar to reach 100%
                    setTimeout(function() {
                        const responseElement = document.getElementById('response-container');

                        // Build the HTML content
                        let htmlContent = '';

                        // Main Heading
                        htmlContent += '<h1 class="mt-4">Summarized Troubleshooting Steps</h1>';

                        // First Disclaimer
                        htmlContent += '<div class="alert alert-warning" role="alert">';
                        htmlContent += '<strong>Disclaimer:</strong> These instructions are AI generated. Please proceed at your own risk.';
                        htmlContent += '</div>';

                        // Response Text in a Card
                        htmlContent += '<div class="card mb-4">';
                        htmlContent += '<div class="card-body">';

                        // Sanitize the markdown text received from the server
                        const rawMarkdown = data.markdown_text;

                        // Set options for Marked.js
                        marked.setOptions({
                            highlight: function(code, lang) {
                                if (lang && hljs.getLanguage(lang)) {
                                    return hljs.highlight(code, { language: lang }).value;
                                } else {
                                    return hljs.highlightAuto(code).value;
                                }
                            },
                            langPrefix: 'hljs language-',
                            breaks: true  // Enable line breaks
                        });

                        // Render the markdown to HTML
                        const renderedMarkdown = marked.parse(rawMarkdown);

                        // Sanitize the rendered HTML
                        const sanitizedContent = DOMPurify.sanitize(renderedMarkdown);

                        // Add the sanitized content to the card body
                        htmlContent += sanitizedContent;

                        htmlContent += '</div></div>'; // Close card-body and card

                        // URLs to Reference Resources (Always Displayed)

                        // Second Heading
                        htmlContent += '<h2 class="mt-4">URLs to Reference Resources</h2>';

                        // Second Disclaimer
                        htmlContent += '<div class="alert alert-info" role="alert">';
                        htmlContent += '<strong>Note:</strong> This application uses OpenAI API to generate responses. OpenAI API does not train models on inputs and outputs.';
                        htmlContent += '</div>';

                        // Links List (Always Displayed)
                        htmlContent += '<ul class="list-group mb-4">';

                        if (data.links && data.links.length > 0) {
                            data.links.forEach(link => {
                                htmlContent += `<li class="list-group-item"><a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a></li>`;
                            });
                        } else {
                            // Display a highlighted warning when no links are available
                            htmlContent += '<div class="alert alert-warning" role="alert">';
                            htmlContent += '<strong>Warning:</strong> No reference URLs were provided to the AI. The response may have a higher chance of containing inaccuracies or hallucinations.';
                            htmlContent += '</div>';
                        }

                        htmlContent += '</ul>';

                        // Insert the content into the page
                        responseElement.innerHTML = htmlContent;
                        responseElement.style.display = "block"; // Show the response container

                        // Initialize Highlight.js
                        hljs.highlightAll();

                        // Hide the progress container after loading content
                        document.getElementById("progress-container").style.display = "none";

                        submitButton.disabled = false; // Re-enable the submit button
                    }, 500);
                } else {
                    // Handle error message
                    displayError(data.message);
                    // Hide the progress container in case of error
                    document.getElementById("progress-container").style.display = "none";
                    submitButton.disabled = false; // Re-enable the submit button
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error("Error submitting form:", error);
                displayError("An unexpected error occurred. Please try again.");
                // Hide the progress container in case of error
                document.getElementById("progress-container").style.display = "none";
                submitButton.disabled = false; // Re-enable the submit button
            });
        }

        // Function to display error messages
        function displayError(message) {
            const warningElement = document.getElementById('warning-message');
            warningElement.textContent = message;
            warningElement.style.display = "block";
        }

        // Attach the showProgress function to the form's submit event
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelector("form").addEventListener("submit", showProgress);
        });
    </script>
</head>
<body>
    <!-- Initial message with reCAPTCHA -->
    <div id="recaptcha-message" class="custom-container">
        <h1>Complete reCAPTCHA to Continue</h1>
        <div class="g-recaptcha" data-sitekey="6LdcAGgqAAAAAD7cXNskdez3wvGivm-lMhuLTBhj" data-callback="recaptchaCallback"></div>
    </div>

     <!-- The main container is hidden initially and only shown after reCAPTCHA is solved -->
     <div id="main-container" class="custom-container" style="display: none;">
        <h1>Civil 3D AI Assistant</h1>
        <p>This is an independent application and is not in any way associated with Autodesk.</p>

        <!-- Updated form with onsubmit event -->
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group mb-3">
                <label for="year_version" class="form-label">Select Your Civil 3D Version:</label>
                <select name="year_version" id="year_version" class="form-select">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                </select>
            </div>

            <div class="form-group mb-3">
                <label for="user_input" class="form-label">Please don't enter any sensitive information:</label>
                <input type="text" name="user_input" id="user_input" class="form-control" placeholder="Enter your query here..." required>
            </div>

            <div class="form-group mb-3">
                <button type="submit" id="submit-btn" class="btn btn-primary">Submit</button>
            </div>
        </form>

        <!-- Progress Bar with Processing Message (initially hidden) -->
        <div id="progress-container" class="progress-container mb-3" style="display: none;">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            <p class="mt-2">Processing your request, please wait...</p>
        </div>

        <!-- Warning Message -->
        <p id="warning-message" class="text-danger" style="display: none;"></p>

        <!-- Response Container (Initially Hidden) -->
        <div id="response-container" style="display: none;"></div>

    </div>

    <!-- Bootstrap 5.3.3 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>